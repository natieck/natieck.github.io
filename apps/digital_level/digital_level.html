<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Digital Level</title>
  </head>
  <body>
    <h1>Digital Level</h1>
    <button id="sensor_button" onclick="sensor_click(this);">start</button>
    &nbsp;&nbsp;<span id="counter"></span>
    <div style="background: #aaa; border: 1px solid #222; border-radius: 15px; overflow: hidden;">
      <canvas id="level_canvas"></canvas>
    </div>
    <p>Euler angles (absolute:<span id="angle_absolute"></span>)<br />
      alpha:<span id="alpha_angle"></span>,&nbsp;&nbsp;
      beta :<span id="beta_angle"></span>,&nbsp;&nbsp;
      gamma:<span id="gamma_angle"></span><br />
      angle:<span id="angle_from_horizontal"></span>
    </p>
    <p>Acceleration including Gravity<br />
      ax:<span id="acc_x"></span>,&nbsp;&nbsp;
      ay:<span id="acc_y"></span>,&nbsp;&nbsp;
      az:<span id="acc_z"></span>
    </p>
    <span id="debug"></span>
    <script>
      let ar, br, gr, ax, ay, az;
      const degtorad = Math.PI/180, radtodeg = 180/Math.PI;
      let oriflg, iosflg = 0, sensorflg = 0;
      let cnt = 0, ncnt = 10;
      let cwidth;
      cwidth = Math.round(0.95*document.documentElement.clientWidth);
      if(cwidth === undefined)cwidth = 301;else if(!cwidth%2)cwidth--;
      else if(cwidth > document.documentElement.clientHeight)cwidth = document.documentElement.clientHeight;
      const canvas = document.getElementById('level_canvas');
      canvas.width = cwidth;
      canvas.height = cwidth;
      let cx = (canvas.width-1)/2, cy = (canvas.height-1)/2;
      let ctx = canvas.getContext('2d');
      level_draw(cx,cy,0,0,0,0);

      function sensor_click(button){
        sensorflg = 1-sensorflg;
        if(sensorflg){
          button.innerHTML = "stop";
          if(DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function'){
            // for iOS 13 or later
            // Get permission
            DeviceOrientationEvent.requestPermission().then(permissionState => {
              if (permissionState === 'granted') {
                // Add devicemotion to event listeners if permission is granted
                window.addEventListener("deviceorientation",ori_sensor,false);
              }else{
                // Processing if a permit is not granted
                alert('DeviceOrientationEvent is not permitted.');
              }
            }).catch(console.error) // Case that permission could not be obtained due to non-https communication, etc
          }else{
            // Browsers other than the above
            window.addEventListener("deviceorientation",ori_sensor,false);
          }
          if(DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission === 'function'){
            // for iOS 13 or later
            // Get permission
            DeviceMotionEvent.requestPermission().then(permissionState => {
              if (permissionState === 'granted') {
                // Add devicemotion to event listeners if permission is granted
                iosflg = 1;
                window.addEventListener("devicemotion",acc_sensor,false);
              }else{
                // Processing if a permit is not granted
                alert('DeviceMotionEvent is not permitted.');
              }
            }).catch(console.error) // Case that permission could not be obtained due to non-https communication, etc
          }else{
            // Browsers other than the above
            window.addEventListener("devicemotion",acc_sensor,false);
          }
        }else{
          button.innerHTML = "start";
          window.removeEventListener("deviceorientation",ori_sensor,false);
          window.removeEventListener("devicemotion",acc_sensor,false);
        }
      }
      
      function ori_sensor(ev){
        oriflg = ev.absolute;
        ar = ev.alpha || 0;
        br = ev.beta || 0;
        gr = ev.gamma || 0;
      }
      
      function acc_sensor(ev){
	document.getElementById('counter').innerHTML=`${screen.orientation.angle} : ${cnt}`;
        if(++cnt > ncnt){
          cnt = 0;
          const acc=ev.accelerationIncludingGravity;
          if(iosflg){
            // Reverse the sign for iOS
            ax = -acc.x || 0;
            ay = -acc.y || 0;
            az = -acc.z || 0;
          }else{
            ax = acc.x || 0;
            ay = acc.y || 0;
            az = acc.z || 0;
          }
          document.getElementById('angle_absolute').innerHTML=oriflg;
          document.getElementById('alpha_angle').innerHTML=ar.toFixed(3);
          document.getElementById('beta_angle').innerHTML=br.toFixed(3);
          document.getElementById('gamma_angle').innerHTML=gr.toFixed(3);
          document.getElementById('acc_x').innerHTML=ax.toFixed(3);
          document.getElementById('acc_y').innerHTML=ay.toFixed(3);
          document.getElementById('acc_z').innerHTML=az.toFixed(3);
          let theta = Math.acos(az/Math.sqrt(ax*ax+ay*ay+az*az))*radtodeg;
	  if(theta>90)theta = 180-theta;else if(theta<-90)theta = -(180+theta);
          let theta_sign;
          if(Math.abs(br) < Math.abs(gr))theta_sign = -Math.sign(gr);
          else theta_sign = Math.sign(br);
          if(theta_sign!=0)theta*=theta_sign;
          document.getElementById('angle_from_horizontal').innerHTML=theta.toFixed(3);

          let w, x, y, x0, y0, x1, y1;
	  let grad;
	  if(ax){
		  
	    grad = ay/ax;
	    if(Math.abs(grad) < cy/cx){
	      x = cx*theta/45;
	      y = -x*grad;
	      x0 = 0;
	      x1 = cx*2;
	      y0 = cx*grad+cy;
	      y1 = -cx*grad+cy;
	    }else{
	      y = -cy*theta/45;
	      x = -y/grad;
	      x0 = cy/grad+cx;
	      x1 = -cy/grad+cx;
	      y0 = 0;
	      y1 = cy*2;
	    }
            if(x>cx){w=cx/x;x=cx;y*=w;}else if(x<-cx){w=-cx/x;x=-cx;y*=w;}
	    if(y>cy){w=cy/y;x*=w;y=cy;}else if(y<-cy){w=-cy/y;x*=w;y=-cy;}
            x += cx;
	    y += cy;
	  
	    if(screen.orientation.angle == 90){
	      w=-(x-cx)+cx;x=y;y=w;
	      w=x0;x0=-(y0-cy)+cy;y0=w;
	      w=x1;x1=-(y1-cy)+cy;y1=w;
	    }else if(screen.orientation.angle == 270){
	      w=x;x=-y;y=w;
	      w=x0;x0=-(y0-cy)+cy;y0=w;
	      w=x1;x1=-(y1-cy)+cy;y1=w;
	    }
		  
	  }else{
	      x = cx;
	      y = cy;
	      x0 = y0 = x1 = y1 = 0;
	  }

	  document.getElementById('debug').innerHTML=`${x.toFixed(3)} ${y.toFixed(3)} ${x0.toFixed(3)} ${y0.toFixed(3)} ${x1.toFixed(3)} ${y1.toFixed(3)} ${grad.toFixed(3)}`;
	  level_draw(x,y,x0,y0,x1,y1);
        }
      }
      function level_draw(x,y,x0,y0,x1,y1){
	ctx.fillStyle = "#e6f64b";
        ctx.fillRect(0,0,canvas.width-1,canvas.height-1);

        ctx.strokeStyle = "#a8c343";
	ctx.fillStyle = "#fafae6";
        ctx.beginPath();
	ctx.setLineDash([]);
        ctx.arc(x, y, 21, 0, Math.PI*2);
	ctx.fill();
	ctx.moveTo(x-10,y);
	ctx.lineTo(x+10,y);
	ctx.moveTo(x,y-10);
	ctx.lineTo(x,y+10);
	ctx.stroke();

	if(x0||y0||x1||y1){
          ctx.strokeStyle = "#4444ff";
	  ctx.beginPath();
	ã€€ctx.setLineDash([5, 5]);
	  ctx.moveTo(x0,y0);
	  ctx.lineTo(x1,y1);
	  ctx.stroke();
	}
	
	ctx.fillStyle = 'green';
        ctx.beginPath();
        ctx.arc(cx, cy, 5, 0, Math.PI*2);
	ctx.fill();
      }
    </script>
  </body>
</html>
